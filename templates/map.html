{% extends "base.html" %}
{% block title %}Map{% endblock %}
{% block content %}

{% if user.is_authenticated %}
    {% load leaflet_tags %}
    {% leaflet_js %}
    {% leaflet_css %}
    <div class="container">
        <nav class="navbar navbar-expand-md">
            <a class="navbar-brand">Dublin Landmarksüìç</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'home' %}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'map' %}">Landmarks</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'logout' %}">Log Out</a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>


    <div class="container data-vis">
        <div class="row">
            <div class="col-md-6">
                <div class="map">
                    {% leaflet_map "yourmap" callback="window.map_init" %}
                </div>
                <div class="alert alert-primary mt-3">
                    <p><span id="favoriteLocation">{{ favorite_location }} ü§Ø</span></p>
                    <p>Favorite since: <span id="lastUpdated">{{ last_updated }}</span></p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-success" id="locationAlert">
                    <h4 class="alert-heading">Your Location</h4>
                    <p>Lon: <span id="longitude" class="lon-span"></span>
                    Lat: <span id="latitude"></span></p>
                </div>

                <div class="mt-3">
                    <select class="form-control" id="locationSelect">
                        <option value="" selected disabled>Select a landmark</option>
                        {% for landmark in landmarks %}
                            <option value="{{ landmark.latitude }},{{ landmark.longitude }}" data-description="{{ landmark.description }}">{{ landmark.description }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="text-center mt-3">
                    <button class="btn btn-primary updatedb" onclick="update_db()">Update Favourite Landmark</button>
                </div>
            </div>
        </div>
    </div>


    <script>
    function map_init(map, options) {
        if ("geolocation" in navigator) {

            {% for landmark in landmarks %}
                var landmark_latitude = {{ landmark.latitude }};
                var landmark_longitude = {{ landmark.longitude }};
                var landmark_description = "{{ landmark.description }}";

                var landmarkMarker = L.marker([landmark_latitude, landmark_longitude]).addTo(map);
                landmarkMarker.bindPopup(landmark_description);
            {% endfor %}

            navigator.geolocation.getCurrentPosition(function(position) {
                var latitude = position.coords.latitude;
                var longitude = position.coords.longitude;


                // Define a custom icon for the user's location marker
                var userLocationIcon = L.divIcon({
                    className: 'custom-icon',
                    html: '<i class="fa fa-circle-user"></i>', // You can use any desired icon or HTML content
                });

                var userLocationMarker = L.marker([latitude, longitude], { icon: userLocationIcon }).addTo(map);
                userLocationMarker.bindPopup("You're Here");

                map.setView([latitude, longitude], 11);

                $("#longitude").text(longitude);
                $("#latitude").text(latitude);

            });
        } else {
            alert("No geolocation supported on this browser!!");
        }
    }

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    function update_db() {
        const crsf_token = getCookie('csrftoken');
        var HOST = location.protocol + "//" + location.host;
        var locationAlert = $("#locationAlert");

        var selectedLocation = $("#locationSelect option:selected");
        var locString = selectedLocation.val();
        var description = selectedLocation.data("description");

        if (!locString) {
            locationAlert.removeClass("alert-success").addClass("alert-danger").text("Please select a location.").show();
            return;
        }

        $.ajax({
            type: "POST",
            headers: {
                'X-CSRFToken': crsf_token
            },
            url: HOST + "/updatedb/",
            data: {
                point: locString,
                description: description
            }
        }).done(function (data, status, xhr) {
            console.log(data["message"]);
            locationAlert.removeClass("alert-danger").addClass("alert-success").html("Your favourite landmark is now <b>" + description + "</b><br>" + "Lon, Lat: " + locString).show();
            // Update the alert content
            $("#longitude").text(data["lon"]);
            $("#latitude").text(data["lat"]);
        }).fail(function (xhr, status, error) {
            console.log(error);
            locationAlert.removeClass("alert-success").addClass("alert-danger").text("Failed to update location: " + error);
        }).always(function () {
            locationAlert.show();
        });
    }

    </script>

{% else %}
<div class="container mt-5">
    <div class="alert alert-warning" role="alert">
        You are not logged in
    </div>
    <a href="{% url 'login' %}" class="btn btn-success">Log In</a>
</div>
{% endif %}
{% endblock %}
